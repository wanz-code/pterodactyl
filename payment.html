<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pembayaran QRIS - Wanz Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body {
      margin:0; font-family: Inter, sans-serif; background:#060712; color:#eaf3ff;
      display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px;
    }
    .card {
      background:#0b0f1c; border:1px solid rgba(255,255,255,0.08); border-radius:20px;
      padding:24px; max-width:460px; width:100%; text-align:center; box-shadow:0 12px 40px rgba(0,0,0,0.6);
      animation: fadeIn .5s ease;
    }
    .title { font-weight:800; font-size:20px; margin-bottom:12px; color:#00ffd1; }
    .spinner {
      width:46px; height:46px; border:4px solid rgba(255,255,255,0.15);
      border-top-color:#7b61ff; border-radius:50%; margin:24px auto;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to{ transform:rotate(360deg)} }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:none} }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.05)} 100%{transform:scale(1)} }

    img.qr { width:280px; height:280px; border-radius:14px; margin:18px 0; box-shadow:0 0 20px rgba(0,255,209,0.25); animation:pulse 2s infinite }
    .muted { font-size:13px; color:#9aa0b0; }
    .detail { text-align:left; margin-top:14px; font-size:14px; line-height:1.5 }
    .detail div { margin:6px 0; }
    .countdown { font-weight:800; font-size:18px; color:#ffcc00; margin-top:10px }

    .btn {
      display:inline-block; margin:8px 4px; padding:10px 18px; border-radius:10px; font-weight:800;
      border:0; cursor:pointer; background:linear-gradient(90deg,#7b61ff,#00ffd1); color:#061018;
      transition:transform .25s, box-shadow .25s;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.4) }
    .btn:active { transform:scale(.95) }
    .btn.danger { background:linear-gradient(90deg,#ff4d4d,#ff7b7b); color:#fff }

    #toast {
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(40px);
      background:rgba(20,20,28,0.95); padding:12px 18px; border-radius:12px;
      font-size:14px; font-weight:600; opacity:0; transition:.35s; z-index:999;
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
    }
    #toast.show { opacity:1; transform:translateX(-50%) translateY(0) }

    /* Success screen */
    .successBox {
      text-align:center; padding:30px;
      animation: fadeIn .5s ease;
    }
    .checkmark {
      width:80px; height:80px; border-radius:50%; display:inline-block;
      box-shadow:0 0 0 5px #0f0 inset; margin-bottom:15px; position:relative;
      animation: popIn 0.4s ease;
    }
    .checkmark_stem {
      width:6px; height:30px; background:#0f0; position:absolute;
      left:36px; top:18px; transform:rotate(45deg) scaleY(0);
      transform-origin:top left; animation:drawStem 0.4s ease forwards 0.3s;
    }
    .checkmark_kick {
      width:6px; height:15px; background:#0f0; position:absolute;
      left:24px; top:42px; transform:rotate(-45deg) scaleY(0);
      transform-origin:top right; animation:drawKick 0.3s ease forwards 0.7s;
    }
    @keyframes popIn { from{transform:scale(0)} to{transform:scale(1)} }
    @keyframes drawStem { to{ transform: rotate(45deg) scaleY(1);} }
    @keyframes drawKick { to{ transform: rotate(-45deg) scaleY(1);} }
  </style>
</head>
<body>
  <div class="card" id="payBox">
    <div class="title">Pembayaran QRIS</div>
    <div id="loading">
      <div class="spinner"></div>
      <div class="muted">Menyiapkan pembayaran...</div>
    </div>
    <div id="payContent" style="display:none">
      <div class="countdown" id="countdown">15:00</div>
      <img id="qrImg" class="qr" src="" alt="QRIS"/>
      <div id="detail" class="detail"></div>
      <div>
        <button id="btnDownload" class="btn">Download QR</button>
        <button id="btnRefresh" class="btn">Cek Status</button>
        <button id="btnExit" class="btn danger">Keluar</button>
      </div>
    </div>
    <div id="successBox" class="successBox" style="display:none">
      <div class="checkmark">
        <span class="checkmark_stem"></span>
        <span class="checkmark_kick"></span>
      </div>
      <h3 style="color:#0f0;margin-bottom:8px">Pembayaran Sukses!</h3>
      <p class="muted">Panel berhasil dibuat. Silakan cek history di halaman utama.</p>
      <a href="./index.html" class="btn">üîô Kembali ke Home</a>
    </div>
  </div>

  <div id="toast">Notifikasi</div>

<script>
const STORAGE_KEY = "wanz_store_history_v2";

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg; t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}

function fmtWIB(iso){ try{ return new Date(iso).toLocaleString("id-ID",{timeZone:"Asia/Jakarta"});}catch(e){return iso;} }
function nowISO(){ return new Date().toISOString(); }

function loadHistory(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");}catch(e){return[]} }
function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }
function updateHistory(trxId,status,extra={}){
  const h = loadHistory(); const idx = h.findIndex(x=>x.id===trxId);
  const timeWIB = fmtWIB(nowISO());
  if(idx===-1){ h.unshift(Object.assign({id:trxId,status,timeWIB},extra)); }
  else { h[idx] = Object.assign({},h[idx],{status,timeWIB},extra); }
  saveHistory(h);
}

const urlParams = new URLSearchParams(location.search);
const pkg = urlParams.get("pkg");
const username = urlParams.get("username");
const loading = document.getElementById("loading");
const payContent = document.getElementById("payContent");
const successBox = document.getElementById("successBox");
const qrImg = document.getElementById("qrImg");
const detail = document.getElementById("detail");
const countdownEl = document.getElementById("countdown");

let trxId=null, pollTimer=null, countdownTimer=null, expireAt=null;

// Generate QR
(async()=>{
  try{
    const res = await fetch(`/api/database?action=create-qris`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ productKey: pkg, username })
});
    const data = await res.json();
    if(!data || !data.id) throw new Error("Gagal buat QRIS");

    trxId = data.id; expireAt = new Date(data.expiresAt);
    qrImg.src = data.qr;
    detail.innerHTML = `
      <div>üì¶ Paket: <b>${pkg}</b></div>
      <div>üë§ Username: <b>${username}</b></div>
      <div>üí∞ Nominal: Rp${Number(data.amount||0).toLocaleString("id-ID")}</div>
      <div>üÜî TrxID: ${trxId}</div>
      <div class="muted">‚åõ Berlaku sampai: ${fmtWIB(data.expiresAt)}</div>
    `;
    updateHistory(trxId,"pending",{pkgName:pkg,username});

    loading.style.display="none"; payContent.style.display="block";

    pollTimer=setInterval(checkStatus,5000);
    startCountdown(15*60); // 15 menit
  }catch(e){
    loading.innerHTML=`<div style="color:#ff7b7b">‚ùå ${e.message}</div>`;
  }
})();

function startCountdown(seconds){
  let s=seconds;
  countdownTimer=setInterval(()=>{
    let m=Math.floor(s/60), sec=s%60;
    countdownEl.textContent=`${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    if(s<=0){
      clearInterval(countdownTimer);
      updateHistory(trxId,"expired",{pkgName:pkg,username});
      showToast("‚ö†Ô∏è QRIS kadaluarsa");
    }
    s--;
  },1000);
}

async function checkStatus(){
  if(!trxId) return;
  try{
    const res = await fetch(`/api/database?action=check-status`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ transactionId: trxId, productKey: pkg, username })
});
    const data = await res.json();
    if(!data || !data.status) return;

    if(data.status==="paid"){
      updateHistory(trxId,"paid",{pkgName:pkg,username,panel:data.panel||null});
      clearInterval(pollTimer); clearInterval(countdownTimer);
      payContent.style.display="none"; successBox.style.display="block";
      showToast("‚úÖ Pembayaran sukses!");
    }
    else if(data.status==="expired" || data.status==="failed"){
      updateHistory(trxId,data.status,{pkgName:pkg,username});
      clearInterval(pollTimer); clearInterval(countdownTimer);
      showToast("‚ùå Pembayaran "+data.status);
    }
  }catch(e){ console.warn(e); }
}

// Tombol aksi
document.getElementById("btnDownload").addEventListener("click",()=>{
  const a=document.createElement("a");
  a.href=qrImg.src; a.download=`qris-${trxId}.png`; a.click();
});
document.getElementById("btnRefresh").addEventListener("click", checkStatus);
document.getElementById("btnExit").addEventListener("click",()=>{
  showToast("‚ö†Ô∏è Yakin mau keluar dari halaman ini?");
});

</script>
</body>
</html>