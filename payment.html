<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pembayaran QRIS — Wanz Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#060712; --card:#0b0f1c; --muted:#9aa0b0; --accent:#7b61ff; --accent2:#00ffd1;
      --success:#4ee3a1; --danger:#ff7b7b; --glass:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:
      radial-gradient(900px 300px at 10% 10%, rgba(123,97,255,0.06), transparent 8%),
      linear-gradient(180deg,#030513,#071022); color:#eaf3ff; -webkit-font-smoothing:antialiased;}
    .wrap{width:100%;max-width:920px;margin:28px auto;padding:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
    .row{display:flex;gap:18px;align-items:flex-start}
    .col{flex:1}
    .side{width:360px;min-width:260px}
    .title{font-weight:800;font-size:18px;color:var(--accent2);margin-bottom:6px}
    .muted{color:var(--muted);font-size:13px}
    .qrBox{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;text-align:center;transition:all .32s ease}
    img.qr{width:300px;height:300px;border-radius:12px;max-width:86vw;display:block;margin:12px auto;box-shadow:0 24px 60px rgba(0,0,0,0.6)}
    .countdown{font-weight:800;color:var(--accent2);font-size:18px}
    .detail{margin-top:8px;text-align:left;font-size:14px}
    .detail div{margin:6px 0;display:flex;justify-content:space-between;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061018;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800;transition:transform .2s}
    .btn:hover{transform:translateY(-3px)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:700}
    .btn.danger{background:linear-gradient(90deg,#ff4d4d,#ff7b7b);color:#fff}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    .spinner{width:42px;height:42px;border-radius:50%;border:4px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite;margin:18px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .success{border:1px solid rgba(78,227,161,0.12);background:linear-gradient(180deg, rgba(78,227,161,0.03),transparent);padding:16px;border-radius:12px}
    .panelCard{background:#071022;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    .kbd{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:700}
    .copyBtn{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:6px 8px;border-radius:8px;cursor:pointer}
    .mutedSmall{color:var(--muted);font-size:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .toast{position:fixed;left:50%;bottom:30px;transform:translateX(-50%) translateY(20px);background:rgba(20,20,28,0.95);padding:12px 18px;border-radius:12px;color:#fff;font-weight:700;opacity:0;transition:all .35s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    /* responsive */
    @media(max-width:880px){ .row{flex-direction:column} .side{width:100%} img.qr{width:260px;height:260px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Pembayaran QRISl</div>
        <div class="mutedSmall">Sistem otomatis</div>
      </div>
      <div class="mutedSmall">XCVI</div>
    </div>

    <div class="card" id="card">
      <div class="row">
        <div class="col">
          <div id="loader" style="text-align:center">
            <div class="spinner" id="spinner"></div>
            <div class="muted" id="loaderText">Menyiapkan pembayaran...</div>
          </div>

          <div id="payContent" style="display:none">
            <div class="qrBox" id="qrBox">
              <div class="countdown" id="countdown">--:--</div>
              <img id="qrImg" class="qr" src="" alt="QRIS" />
              <div class="mutedSmall" id="qrNote" style="margin-top:8px"></div>
              <div style="margin-top:12px" class="flex">
                <button id="btnDownload" class="btn">Download QR</button>
                <button id="btnRefresh" class="btn ghost">Cek Status</button>
                <button id="btnCancel" class="btn danger">Batal</button>
              </div>
            </div>

            <div class="detail" id="detail"></div>
          </div>

          <div id="successBox" style="display:none;margin-top:12px">
            <div class="success" id="successWrap">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:800;color:var(--success)">✅ Pembayaran diterima</div>
                  <div class="mutedSmall" id="successTime"></div>
                </div>
                <div><button id="btnBackHome" class="btn ghost"> Home</button></div>
              </div>

              <div style="margin-top:12px" id="panelArea"></div>
            </div>
          </div>
        </div>

        <aside class="side">
          <div class="panelCard">
            <div style="font-weight:800;margin-bottom:8px">Rangkuman Pembayaran</div>
            <div class="mutedSmall">Pastikan data benar sebelum membayar</div>
            <div style="margin-top:12px">
              <div style="display:flex;justify-content:space-between"><div class="muted">Paket</div><div id="sumPkg" class="kbd">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Username</div><div id="sumUser" class="kbd">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Nominal</div><div id="sumAmount" class="kbd">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">TrxID</div><div id="sumTrx" class="kbd">-</div></div>
              <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Berlaku sampai</div><div id="sumExpire" class="mutedSmall">-</div></div>
            </div>

            <div style="margin-top:14px;display:flex;gap:8px">
              <button id="openHistory" class="btn ghost">Lihat History</button>
              <button id="contactAdmin" class="btn">Hubungi Admin</button>
            </div>
            <div style="margin-top:12px" class="mutedSmall">Jika status "paid" tapi panel gagal dibuat, admin akan menerima notifikasi otomatis.</div>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Notifikasi</div>

<script>
/* PAYMENT FLOW FIXED — sesuai database.js expectations
   - create-qris: POST { productKey, username } -> returns { ok:true, qris: { transactionId, qr_image, totalAmount, expiredAt, raw } }
   - check-status: POST { transactionId, productKey, username } -> returns { ok:true, status:'paid'|'pending'|... , panel? }
*/

const STORAGE_KEY = "wanz_store_history_v2";
const urlParams = new URLSearchParams(location.search);
const pkg = urlParams.get("pkg") || '';
const username = urlParams.get("username") || '';

const loader = document.getElementById('loader');
const spinner = document.getElementById('spinner');
const loaderText = document.getElementById('loaderText');
const payContent = document.getElementById('payContent');
const qrImg = document.getElementById('qrImg');
const countdownEl = document.getElementById('countdown');
const detailEl = document.getElementById('detail');
const btnDownload = document.getElementById('btnDownload');
const btnRefresh = document.getElementById('btnRefresh');
const btnCancel = document.getElementById('btnCancel');
const btnBackHome = document.getElementById('btnBackHome');
const successBox = document.getElementById('successBox');
const successWrap = document.getElementById('successWrap');
const successTime = document.getElementById('successTime');
const panelArea = document.getElementById('panelArea');
const sumPkg = document.getElementById('sumPkg');
const sumUser = document.getElementById('sumUser');
const sumAmount = document.getElementById('sumAmount');
const sumTrx = document.getElementById('sumTrx');
const sumExpire = document.getElementById('sumExpire');
const toast = document.getElementById('toast');
const openHistory = document.getElementById('openHistory');
const contactAdmin = document.getElementById('contactAdmin');

let trxId = null;
let pollTimer = null;
let countdownTimer = null;
let expireAt = null;
let qrDataUrl = null;
let lastStatus = null;

// utils
function showToast(msg, t=3000){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), t); }
function fmtWIB(iso){ try{ return new Date(iso).toLocaleString('id-ID',{timeZone:'Asia/Jakarta'}); } catch(e){ return iso; } }
function nowISO(){ return new Date().toISOString(); }
function saveHistoryRecord(item){ const h = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); h.unshift(item); if(h.length>200) h.pop(); localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }
function updateHistory(id, status, extra={}){ const h = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); const idx = h.findIndex(x=>x.id===id); const rec = Object.assign({id, status, timeWIB: fmtWIB(nowISO())}, extra); if(idx===-1){ h.unshift(rec); } else { h[idx] = Object.assign({}, h[idx], rec); } localStorage.setItem(STORAGE_KEY, JSON.stringify(h)); }

// copy helper
async function copyToClipboard(text){ try { await navigator.clipboard.writeText(text); showToast('Disalin ke clipboard'); } catch(e) { showToast('Gagal salin'); } }

// init summary
sumPkg.textContent = pkg || '-';
sumUser.textContent = username || '-';

// safety: require params
if(!pkg || !username){
  loaderText.textContent = 'Parameter paket atau username tidak ditemukan. Kembali ke halaman utama.';
  spinner.style.display = 'none';
  setTimeout(()=>{ /* keep */ }, 2000);
} else {
  createQris();
}

// create QRIS (POST)
async function createQris(){
  try {
    loaderText.textContent = 'Membuat QRIS...';
    const res = await fetch('/api/database?action=create-qris', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ productKey: pkg, username })
    });
    const data = await res.json();

    if(!res.ok || !data || !data.ok || !data.qris){
      throw new Error((data && (data.error || JSON.stringify(data))) || 'Gagal membuat QRIS');
    }

    const q = data.qris;
    trxId = q.transactionId || q.trxId || ('local-'+Date.now());
    qrDataUrl = q.qr_image || null;
    const amount = q.totalAmount || q.total || q.amount || 0;
    expireAt = q.expiredAt || q.expired_at || q.expiresAt || null;

    // ui fill
    sumAmount.textContent = amount ? `Rp${Number(amount).toLocaleString('id-ID')}` : '-';
    sumTrx.textContent = trxId;
    sumExpire.textContent = expireAt ? fmtWIB(expireAt) : `~${15} menit`;

    // show details & QR
    loader.style.display = 'none';
    payContent.style.display = 'block';
    if(qrDataUrl){
      qrImg.src = qrDataUrl;
    } else if(q.qr_string){
      // fallback: request to generate image via /api/database? but since backend already generates, rarely here
      qrImg.alt = 'QR tersedia (text)';
      qrImg.style.display = 'none';
    }

    detailEl.innerHTML = `
      <div>📦 Paket: <strong>${pkg}</strong></div>
      <div>👤 Username: <strong>${username}</strong></div>
      <div>💰 Nominal: <strong>${amount ? 'Rp'+Number(amount).toLocaleString('id-ID') : '-'}</strong></div>
      <div>🆔 Transaksi: <span class="kbd">${trxId}</span> <button class="copyBtn" onclick="copyToClipboard('${trxId}')">Copy</button></div>
      <div class="mutedSmall">⌛ Berlaku sampai: ${ expireAt ? fmtWIB(expireAt) : ('~'+(15)+' menit') }</div>
    `;
    // local history initial pending record
    saveHistoryRecord({ id: trxId, status: 'pending', pkgName: pkg, username, amount, timeWIB: fmtWIB(nowISO()) });

    // start countdown
    const secondsLeft = calcSecondsLeft(expireAt) || (15*60);
    startCountdown(secondsLeft);

    // start polling
    pollTimer = setInterval(checkStatus, 5000);
    lastStatus = 'pending';
  } catch (err) {
    loaderText.textContent = '❌ ' + (err.message || 'Gagal membuat QRIS');
    spinner.style.display = 'none';
    showToast('Gagal buat QRIS: ' + (err.message || 'error'));
    console.error('createQris error', err);
  }
}

function calcSecondsLeft(expireAt){
  try {
    if(!expireAt) return null;
    const t = new Date(expireAt).getTime();
    const now = Date.now();
    const diff = Math.max(0, Math.floor((t - now)/1000));
    return diff;
  } catch(e){ return null; }
}

function startCountdown(seconds){
  let s = seconds;
  if(typeof s !== 'number' || isNaN(s) || s <= 0) s = 15*60;
  clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    const m = Math.floor(s/60), sec = s%60;
    countdownEl.textContent = `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    if(s <= 0){
      clearInterval(countdownTimer);
      clearInterval(pollTimer);
      updateHistory(trxId, 'expired', { pkgName: pkg, username });
      showToast('⚠️ QRIS kadaluarsa');
      // visually disable buttons
      btnRefresh.disabled = true;
      btnDownload.disabled = true;
      btnCancel.disabled = true;
    }
    s--;
  }, 1000);
}

// check status -> POST
async function checkStatus(){
  if(!trxId) return;
  try {
    const res = await fetch('/api/database?action=check-status', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ transactionId: trxId, productKey: pkg, username })
    });
    const data = await res.json();
    if(!res.ok || !data || !data.ok){
      // handle non-ok but allow transient
      console.warn('check-status non-ok', data);
      return;
    }

    const status = data.status || data.data?.status || null;
    if(!status) return;

    if(status !== lastStatus){
      lastStatus = status;
      updateHistory(trxId, status, { pkgName: pkg, username });
    }

    if(status === 'paid'){
      clearInterval(pollTimer);
      clearInterval(countdownTimer);
      showSuccess(data);
    } else if(status === 'expired' || status === 'failed'){
      clearInterval(pollTimer);
      clearInterval(countdownTimer);
      showToast('Pembayaran ' + status);
      updateHistory(trxId, status, { pkgName: pkg, username });
    } else {
      // pending - nothing
      // optionally show partial info
      console.debug('status', status);
    }

  } catch (err) {
    console.warn('checkStatus error', err);
  }
}

function renderPanel(panel){
  // panel may come from backend CreatePanel
  if(!panel) {
    panelArea.innerHTML = `<div class="mutedSmall">Tidak ada data panel. Admin akan memeriksa manual jika perlu.</div>`;
    return;
  }
  const domain = panel.domain || (panel.domain === undefined ? '-' : panel.domain);
  const usernameP = panel.username || '-';
  const password = panel.password || '-';
  const serverId = panel.serverId || panel.server_id || '-';
  const userId = panel.userId || panel.user_id || '-';

  panelArea.innerHTML = `
    <div style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center"><div class="muted">Panel URL</div><div><button class="btn ghost" onclick="window.open('${escapeForInline(domain)}/auth/login','_blank')">Buka Panel</button></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Username</div><div class="kbd">${escapeForInline(usernameP)}</div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Password</div><div style="display:flex;gap:6px;align-items:center"><div class="kbd">${escapeForInline(password)}</div><button class="copyBtn" onclick="copyToClipboard('${escapeForInline(password)}')">Copy</button></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">Server ID</div><div class="kbd">${escapeForInline(serverId)}</div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px"><div class="muted">User ID</div><div class="kbd">${escapeForInline(userId)}</div></div>
      <div style="margin-top:12px;display:flex;gap:8px"><button class="btn" onclick="copyAllPanel()">📋 Copy Semua</button><button class="btn ghost" onclick="window.location.href='./index.html'">Selesai</button></div>
    </div>
  `;
}

function escapeForInline(s){ if(!s) return ''; return String(s).replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function copyAllPanel(){
  try {
    const html = panelArea.innerText || panelArea.textContent || '';
    copyToClipboard(html);
  } catch(e){ showToast('Gagal copy'); }
}

function showSuccess(data){
  // data may include panel (created) or a message
  payContent.style.display = 'none';
  successBox.style.display = 'block';
  successTime.textContent = fmtWIB(nowISO());
  // if panel exists
  if(data.panel){
    renderPanel(data.panel);
    updateHistory(trxId, 'paid', { pkgName: pkg, username, panel: data.panel });
  } else {
    panelArea.innerHTML = `<div class="mutedSmall">Pembayaran terkonfirmasi, menunggu proses pembuatan panel. Jika tidak otomatis, admin akan memproses.</div>
    <div style="margin-top:12px"><button class="btn" onclick="window.location.href='./index.html'">Kembali ke Home</button></div>`;
    updateHistory(trxId, 'paid', { pkgName: pkg, username });
  }
  showToast('✅ Pembayaran sukses!');
}

// UI actions
btnDownload.addEventListener('click', ()=>{
  if(!qrImg.src) return showToast('QR belum tersedia');
  const a = document.createElement('a');
  a.href = qrImg.src;
  a.download = `qris-${trxId}.png`;
  a.click();
});

btnRefresh.addEventListener('click', async ()=>{
  showToast('Cek status...');
  await checkStatus();
});

btnCancel.addEventListener('click', ()=>{
  if(!confirm('Batalkan transaksi ini?')) return;
  clearInterval(pollTimer); clearInterval(countdownTimer);
  updateHistory(trxId, 'cancelled', { pkgName: pkg, username });
  showToast('Transaksi dibatalkan');
  window.location.href = './index.html';
});

btnBackHome.addEventListener('click', ()=> window.location.href = './index.html');

openHistory.addEventListener('click', ()=>{
  window.location.href = './index.html';
});

contactAdmin.addEventListener('click', ()=> {
  window.open('https://wa.me/6283898286223', '_blank');
});

// press escape to go home
window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') window.location.href = './index.html' });

</script>
</body>
</html>