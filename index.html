<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wanz Official • Order Panel</title>
<link rel="icon" href="data:,WZ" />
<style>
  /* ---------- THEME & LAYOUT (cyberpunk minimal) ---------- */
  :root{
    --bg:#06060b;
    --panel:#0b0d14;
    --muted:#98a0b3;
    --accent:#7b61ff;
    --accent2:#00ffd1;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(123,97,255,0.06);
    --danger:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#e9f0ff;background:linear-gradient(180deg,#03030a 0%, #071224 100%);}
  .app{max-width:1150px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:#071018;font-weight:800;box-shadow:0 10px 30px rgba(123,97,255,0.14)}
  h1{margin:0;font-size:18px}
  .sub{font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .panel-list{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  .card{background:linear-gradient(180deg,var(--glass),transparent);border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:12px;backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(3,6,16,0.6);transition:transform .18s ease, box-shadow .18s ease;cursor:pointer;overflow:hidden}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 48px rgba(0,0,0,0.7)}
  .card h3{margin:0;font-size:15px}
  .muted{color:var(--muted);font-size:13px}
  .price{font-weight:800;color:var(--accent2);font-size:16px}
  .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#061018;padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;letter-spacing:.2px}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  aside .card{position:sticky;top:24px}
  .small{font-size:13px}
  footer{margin-top:28px;color:var(--muted);font-size:13px;text-align:center}

  /* DETAIL fullscreen */
  .detailView{position:fixed;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(3,3,8,0.85));display:none;align-items:center;justify-content:center;z-index:60;padding:18px}
  .detailView.open{display:flex}
  .detailBox{width:100%;max-width:980px;background:linear-gradient(180deg,#071022,#0b0f1c);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.7);animation:pop .26s cubic-bezier(.2,.9,.3,1)}
  @keyframes pop{from{transform:translateY(18px) scale(.98);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
  .detailHeader{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .detailBody{display:flex;gap:18px;margin-top:12px}
  .detailLeft{flex:1}
  .detailRight{width:320px}
  .specs{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .qrBox{background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));padding:12px;border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:8px}
  .qrBox img{width:220px;height:220px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.03)}
  .meta{color:var(--muted);font-size:13px}

  /* MODAL */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{background:var(--panel);padding:14px;border-radius:10px;width:100%;max-width:420px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 20px 60px rgba(0,0,0,0.7)}
  .field{display:flex;flex-direction:column;margin-bottom:10px}
  input[type="text"], input[type="tel"]{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:#eaf3ff}
  label{font-size:13px;color:var(--muted);margin-bottom:6px}

  /* TOAST */
  .notif{position:fixed;right:18px;top:18px;z-index:90;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .toast{min-width:240px;padding:10px 12px;border-radius:8px;color:#061018;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 10px 30px rgba(0,0,0,0.6);font-weight:700}
  .toast.err{background:linear-gradient(90deg,var(--danger),#ff8a8a);color:#fff}
  .tiny{font-size:12px;font-weight:600;color:var(--muted);margin-top:6px}

  /* HISTORY */
  .historyItem{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent)}
  .skeleton{height:12px;background:linear-gradient(90deg,#0d0f14, #121523);border-radius:8px}

  @media (max-width:900px){
    .grid{grid-template-columns:1fr}
    .panel-list{grid-template-columns:repeat(1,1fr)}
    .detailBox{max-width:100%}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">WZ</div>
      <div>
        <h1>Wanz Official — Order Panel</h1>
        <div class="sub">Secure checkout • Minimalist Cyber UI • Jakarta (WIB)</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnHistory" class="btn secondary">History</button>
      <a class="btn" href="#" id="btnDocs">Docs</a>
    </div>
  </header>

  <main class="grid">
    <section>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <h2 style="margin:0">Pilih Paket Panel</h2>
        <div class="muted small">Klik paket untuk melihat detail & beli</div>
      </div>

      <div id="panelList" class="panel-list">
        <!-- cards injected here -->
      </div>
    </section>

    <aside>
      <div class="card" id="cartCard">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div class="muted">Keranjang Sederhana</div>
            <div id="cartSummary" style="font-weight:700">Belum ada order</div>
          </div>
          <div style="text-align:right">
            <div class="muted">Total</div>
            <div id="cartTotal" style="font-weight:800;color:var(--accent2)">Rp0</div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="btnClearCart" class="btn secondary">Clear</button>
          <button id="btnCheckout" class="btn" disabled>Beli (Detail page)</button>
        </div>
        <div style="margin-top:12px" id="miniHistory" class="muted small"></div>
      </div>
    </aside>
  </main>

  <footer>Wanz Official • Sistem Otomatis — jangan lupa set ENV di Vercel</footer>
</div>

<!-- detail fullscreen -->
<div id="detailView" class="detailView" aria-hidden="true">
  <div class="detailBox" role="dialog" aria-modal="true">
    <div class="detailHeader">
      <div>
        <h3 id="detailTitle">Panel 1GB</h3>
        <div id="detailSubtitle" class="muted small">Ringkasan paket</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="openBuyModal" class="btn">Beli Server</button>
        <button id="closeDetail" class="btn secondary">Tutup</button>
      </div>
    </div>

    <div class="detailBody">
      <div class="detailLeft">
        <div class="specs">
          <h4 style="margin:0 0 8px 0">Spesifikasi</h4>
          <div id="detailSpecs" class="muted"></div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4 style="margin:0 0 8px 0">Deskripsi</h4>
          <div id="detailDesc" class="muted">Deskripsi singkat paket.</div>
        </div>
      </div>

      <div class="detailRight">
        <div class="qrBox">
          <div id="qrPlaceholder" class="muted">QR akan muncul di sini setelah klik Beli</div>
          <img id="qrImage" src="" alt="QRIS" style="display:none" />
          <div id="qrMeta" class="meta"></div>
          <div style="width:100%;display:flex;gap:8px;margin-top:8px">
            <button id="btnCancelOrder" class="btn secondary" style="flex:1;display:none">Cancel</button>
            <button id="btnCreatePanel" class="btn" style="flex:1;display:none">Cek & Buat Panel</button>
          </div>
          <div id="panelResult" style="margin-top:8px" class="muted small"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- buy modal -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog">
    <h3 style="margin-top:0">Isi data order</h3>
    <div class="field">
      <label>Username panel</label>
      <input id="inputUsername" type="text" placeholder="contoh: wanzdev" maxlength="15" />
    </div>
    <div class="field">
      <label>Nomor tujuan (contoh: 628123456789)</label>
      <input id="inputNomor" type="tel" placeholder="628..." />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="modalCancel" class="btn secondary">Batal</button>
      <button id="modalSubmit" class="btn">Buat QRIS</button>
    </div>
    <div id="modalError" class="tiny" style="display:none;color:var(--danger)"></div>
  </div>
</div>

<!-- notifications -->
<div class="notif" id="notifRoot"></div>

<script>
/* =========================
   Frontend logic (vanilla)
   ========================= */

(() => {
  const api = {
    packages: '/api/packages',
    createQris: '/api/create-qris',
    checkStatus: '/api/check-status',
    createPanel: '/api/create-panel',
    history: '/api/history'
  };

  // UI elements
  const panelListEl = document.getElementById('panelList');
  const cartSummary = document.getElementById('cartSummary');
  const cartTotalEl = document.getElementById('cartTotal');
  const btnClearCart = document.getElementById('btnClearCart');
  const btnCheckout = document.getElementById('btnCheckout');
  const detailView = document.getElementById('detailView');
  const detailTitle = document.getElementById('detailTitle');
  const detailSubtitle = document.getElementById('detailSubtitle');
  const detailSpecs = document.getElementById('detailSpecs');
  const detailDesc = document.getElementById('detailDesc');
  const openBuyModal = document.getElementById('openBuyModal');
  const closeDetail = document.getElementById('closeDetail');
  const qrImage = document.getElementById('qrImage');
  const qrPlaceholder = document.getElementById('qrPlaceholder');
  const qrMeta = document.getElementById('qrMeta');
  const btnCancelOrder = document.getElementById('btnCancelOrder');
  const btnCreatePanel = document.getElementById('btnCreatePanel');
  const panelResult = document.getElementById('panelResult');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const inputUsername = document.getElementById('inputUsername');
  const inputNomor = document.getElementById('inputNomor');
  const modalCancel = document.getElementById('modalCancel');
  const modalSubmit = document.getElementById('modalSubmit');
  const modalError = document.getElementById('modalError');
  const notifRoot = document.getElementById('notifRoot');
  const btnHistory = document.getElementById('btnHistory');
  const miniHistory = document.getElementById('miniHistory');
  const btnDocs = document.getElementById('btnDocs');

  let PACKAGES = {};
  let currentKey = null;
  let currentOrder = null; // { trxId, product, username, nomor, totalAmount, expiredAt }
  let pollingInterval = null;

  // ---------- helpers ----------
  function toast(text, opts = {}) {
    const d = document.createElement('div');
    d.className = 'toast' + (opts.err ? ' err' : '');
    d.textContent = text;
    notifRoot.appendChild(d);
    setTimeout(()=> {
      d.style.opacity = '0';
      setTimeout(()=> d.remove(), 400);
    }, opts.ttl || 3700);
  }

  function el(tag, cls=''){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
  function fmtRp(n){ return 'Rp' + Number(n).toLocaleString('id-ID'); }
  function fmtWIB(iso){ try{ return new Date(iso).toLocaleString('id-ID',{timeZone:'Asia/Jakarta'}); }catch(e){ return iso; } }

  // safe fetch with timeout and error message
  async function safeFetch(url, opts={}, timeout=15000){
    const controller = new AbortController();
    const id = setTimeout(()=> controller.abort(), timeout);
    try{
      const res = await fetch(url, {...opts, signal: controller.signal});
      clearTimeout(id);
      if (!res.ok) {
        const txt = await res.text().catch(()=>null);
        throw new Error(`HTTP ${res.status} ${res.statusText} ${txt ? ' - ' + txt : ''}`);
      }
      return await res.json();
    } catch(e) {
      clearTimeout(id);
      throw e;
    }
  }

  // ---------- load packages ----------
  async function loadPackages(){
    panelListEl.innerHTML = '';
    const loading = el('div','card'); loading.innerHTML = '<div class="skeleton" style="height:14px;width:40%"></div><div class="skeleton" style="height:12px;width:60%;margin-top:8px"></div>';
    panelListEl.appendChild(loading);
    try {
      const j = await safeFetch(api.packages, { method:'GET' }, 10000);
      if (!j || !j.packages) throw new Error('Invalid packages response');
      PACKAGES = j.packages;
      renderPackages();
    } catch(err){
      panelListEl.innerHTML = '<div class="card"><div class="muted">Gagal memuat paket. <button id="retryPackages" class="btn secondary">Retry</button></div></div>';
      document.getElementById('retryPackages').addEventListener('click', loadPackages);
      toast('Gagal memuat paket: ' + err.message, { err:true, ttl:6000 });
    }
  }

  function renderPackages(){
    panelListEl.innerHTML = '';
    Object.keys(PACKAGES).forEach(k=>{
      const p = PACKAGES[k];
      const card = el('div','card');
      card.innerHTML = `<h3>${p.name}</h3>
        <div class="muted small">${p.ram ? p.ram+' MB RAM • ' : ''}${p.disk ? p.disk+' MB Disk • ' : ''}${p.cpu ? p.cpu+' CPU' : ''}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
          <div>
            <div class="price">${fmtRp(p.price)}</div>
            <div class="muted small">Cores: ${p.cpu || '-'}</div>
          </div>
          <div class="actions">
            <button class="btn" data-key="${k}">Lihat Detail</button>
          </div>
        </div>`;
      panelListEl.appendChild(card);
    });
    panelListEl.querySelectorAll('button.btn').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        openDetail(ev.currentTarget.dataset.key);
      });
    });
  }

  // ---------- detail view ----------
  function openDetail(key){
    const p = PACKAGES[key];
    currentKey = key;
    detailTitle.textContent = p.name;
    detailSubtitle.textContent = (p.ram ? p.ram+' MB RAM • ' : '') + (p.disk ? p.disk+' MB Disk • ' : '') + (p.cpu ? p.cpu+' CPU' : '');
    detailSpecs.innerHTML = `<div class="muted">RAM: ${p.ram || '-' } MB</div><div class="muted">Disk: ${p.disk || '-'} MB</div><div class="muted">CPU: ${p.cpu || '-'}</div><div class="muted">Harga: ${fmtRp(p.price)}</div>`;
    detailDesc.textContent = `${p.name} — panel siap pakai. Cocok untuk kebutuhan hosting panel, manajemen server, game, atau bot.`;
    qrImage.style.display='none';
    qrImage.src='';
    qrPlaceholder.style.display='block';
    qrPlaceholder.textContent='QR akan muncul di sini setelah membuat QRIS';
    qrMeta.textContent='';
    btnCancelOrder.style.display='none';
    btnCreatePanel.style.display='none';
    panelResult.textContent='';
    detailView.classList.add('open');
  }

  document.getElementById('closeDetail').addEventListener('click', ()=> detailView.classList.remove('open'));

  // ---------- buy modal ----------
  openBuyModal.addEventListener('click', ()=> {
    inputUsername.value = '';
    inputNomor.value = '';
    modalError.style.display='none';
    modalBackdrop.style.display='flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  });
  modalCancel.addEventListener('click', ()=> {
    modalBackdrop.style.display='none';
    modalBackdrop.setAttribute('aria-hidden','true');
  });

  function validateUsername(u){ return /^[a-zA-Z0-9_]{3,15}$/.test(u); }
  function validateNomor(n){ return /^[0-9]{8,15}$/.test(n); }

  modalSubmit.addEventListener('click', async ()=>{
    const username = inputUsername.value.trim();
    const nomor = inputNomor.value.trim();
    if (!validateUsername(username)) { modalError.textContent='Username tidak valid (3-15 huruf/angka/underscore)'; modalError.style.display='block'; return; }
    if (!validateNomor(nomor)) { modalError.textContent='Nomor tidak valid. Gunakan format 628... tanpa +'; modalError.style.display='block'; return; }
    modalError.style.display='none';
    modalBackdrop.style.display='none';
    modalBackdrop.setAttribute('aria-hidden','true');
    await createQris(currentKey, username, nomor);
  });

  // ---------- create QRIS ----------
  async function createQris(productKey, username, nomor){
    try {
      toast('Membuat QRIS...', { ttl: 2500 });
      const j = await safeFetch(api.createQris, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ productKey, username, nomor })
      }, 20000);
      if (!j.ok) throw new Error(j.error || 'Invalid QRIS response');
      // j.qris contains response from cashify (we return full data server-side)
      const q = j.qris;
      // q.qr_string may be available or q.qr_image... handle likely shape:
      let qrURL = '';
      if (q.qr_string) {
        // convert to data URL on server normally — but server returned full qris data; if server returned qr as image base64, handle accordingly.
        // our server returns j.qris which is Cashify's json; we expect serverless to wrap qr string or image. If not, we'll call /api/create-qris to return already-ready data.
        // Fallback: if server provided q.qr_base64 or q.qr_image use it; else build URL by requesting server endpoint again.
        // For this frontend, we expect server to return proper qris object and also provide j.qr (dataurl) if implemented server-side.
      }
      // Our /api/create-qris designed to return qris in data shape. Normalize:
      // if server returns field 'qris' and includes 'qr_string' and 'totalAmount' and 'transactionId' and 'expiredAt'
      const totalAmount = q.totalAmount || q.amount || (PACKAGES ? (PACKAGES[productKey] || {}).price : undefined) || 0;
      const trxId = q.transactionId || q.trxId || q.id;
      const expiredAt = q.expiredAt || q.expired || new Date(Date.now()+15*60*1000).toISOString();

      // Try to get image: server is expected to return a data url in j.qrImage or similar.
      if (j.qr && typeof j.qr === 'string' && j.qr.startsWith('data:')) {
        qrURL = j.qr;
      } else if (q.qr_string) {
        // render local qrcode via google chart? better avoid external deps.
        // Instead request server to provide dataURL: our server implementation returns dataUrl (see earlier main server example).
        // if not available, show raw qr_string as plain text for debugging.
        qrURL = null;
      } else {
        qrURL = null;
      }

      // Save current order
      currentOrder = { trxId, product: productKey.toUpperCase(), username, nomor, totalAmount, expiredAt };

      // show qr
      if (qrURL) {
        qrImage.src = qrURL;
        qrImage.style.display='block';
        qrPlaceholder.style.display='none';
      } else {
        qrImage.style.display='none';
        qrPlaceholder.style.display='block';
        qrPlaceholder.textContent = 'QR ready but image not returned by server. Silakan cek invoice.';
      }
      qrMeta.textContent = `${fmtRp(totalAmount)} • Expired: ${fmtWIB(expiredAt)} • Trx: ${trxId}`;
      btnCancelOrder.style.display='inline-block';
      btnCreatePanel.style.display='inline-block';
      panelResult.textContent='';
      toast('QRIS siap. Silakan bayar.', { ttl:4000 });
      // start short polling to update status visually (optional)
      startPollingStatus();
    } catch(err){
      toast('Gagal membuat QRIS: '+err.message, { err:true, ttl:7000 });
    }
  }

  // ---------- polling status ----------
  async function pollStatusOnce(){
    if (!currentOrder || !currentOrder.trxId) return null;
    try {
      const j = await safeFetch(api.checkStatus, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ transactionId: currentOrder.trxId }) }, 12000);
      if (!j.ok) throw new Error(j.error || 'Invalid status response');
      return j;
    } catch(e){
      // don't spam user; return null
      return { ok:false, error: e.message };
    }
  }

  function startPollingStatus(){
    stopPollingStatus();
    pollingInterval = setInterval(async ()=>{
      const res = await pollStatusOnce();
      if (!res) return;
      if (!res.ok) { /* ignore transient */ return; }
      // server returns status as res.status
      const st = res.status;
      if (st === 'paid') {
        toast('Pembayaran terdeteksi. Menyiapkan panel...', { ttl: 3500 });
        stopPollingStatus();
        // auto create panel
        doCreatePanel();
      } else if (st === 'expired') {
        toast('Order expired. QR dihapus/invalid.', { err:true, ttl:4000 });
        stopPollingStatus();
        btnCancelOrder.style.display='none';
        btnCreatePanel.style.display='none';
        currentOrder = null;
      } else {
        // pending - do nothing
      }
    }, 5000);
  }
  function stopPollingStatus(){
    if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
  }

  // ---------- create panel after paid ----------
  async function doCreatePanel(){
    if (!currentOrder) { toast('Tidak ada order aktif', { err:true }); return; }
    try {
      btnCreatePanel.disabled = true;
      const j = await safeFetch(api.createPanel, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ productKey: currentOrder.product.toLowerCase(), username: currentOrder.username, nomor: currentOrder.nomor, trxId: currentOrder.trxId })
      }, 20000);
      if (!j.ok) throw new Error(j.error || 'Failed create panel');
      // show panel info
      const panel = j.panel || j.data || {};
      const serverId = panel.id || panel.serverId || panel.node || panel.server_id || panel.attributes?.id || '—';
      panelResult.innerHTML = `<div style="font-weight:800;color:var(--accent2)">Panel dibuat • Server ID: ${serverId}</div><div class="muted small">Data telah dikirim ke nomor tujuan jika tersedia.</div>`;
      toast('Panel berhasil dibuat!', { ttl:4000 });
      // refresh history
      loadHistory();
    } catch(err){
      toast('Gagal membuat panel: '+err.message, { err:true, ttl:7000 });
    } finally {
      btnCreatePanel.disabled = false;
    }
  }

  // ---------- cancel flow (client-side UI only) ----------
  btnCancelOrder.addEventListener('click', ()=>{
    // We don't have delete endpoint; just hide UI and mark canceled locally
    stopPollingStatus();
    currentOrder = null;
    qrImage.style.display='none';
    qrPlaceholder.style.display='block';
    qrPlaceholder.textContent='QR dibatalkan';
    btnCancelOrder.style.display='none';
    btnCreatePanel.style.display='none';
    panelResult.textContent='';
    toast('Order dibatalkan (UI). Jika perlu hapus di server, gunakan admin panel.', { ttl:3500 });
    loadHistory();
  });

  // ---------- history ----------
  async function loadHistory(){
    try {
      const j = await safeFetch(api.history, { method:'GET' }, 10000);
      if (!j.ok) throw new Error(j.error || 'Invalid history');
      const list = j.data || [];
      miniHistory.innerHTML = '';
      (list.slice(-5).reverse()).forEach(it=>{
        const div = el('div','muted small');
        div.textContent = `${fmtWIB(it.createdAt || it.panelCreatedAt || new Date().toISOString())} • ${it.product} • ${fmtRp(it.totalAmount || 0)} • ${it.status || '—'}`;
        miniHistory.appendChild(div);
      });
    } catch(e){
      // ignore silently
    }
  }

  // ---------- history modal ----------
  btnHistory.addEventListener('click', async ()=>{
    try {
      const j = await safeFetch(api.history, { method:'GET' }, 10000);
      if (!j.ok) throw toast('Gagal ambil history','err');
      showHistoryModal(j.data || []);
    } catch(e){ toast('Gagal ambil history: '+e.message, { err:true }); }
  });

  function showHistoryModal(list){
    const box = document.createElement('div');
    box.style.position='fixed';box.style.inset=0;box.style.background='rgba(0,0,0,0.6)';box.style.display='flex';box.style.alignItems='center';box.style.justifyContent='center';box.style.zIndex=120;
    const inner = document.createElement('div'); inner.style.width='min(980px,95%)'; inner.style.maxHeight='80vh'; inner.style.overflowY='auto'; inner.style.background='linear-gradient(90deg,#07101a,#081025)'; inner.style.borderRadius='12px'; inner.style.padding='18px'; inner.style.border='1px solid rgba(255,255,255,0.03)';
    inner.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">Riwayat Order</h3><div><button id="closeHist" class="btn secondary">Tutup</button></div></div><div style="margin-top:12px" id="histList"></div>';
    box.appendChild(inner); document.body.appendChild(box);
    document.getElementById('closeHist').addEventListener('click', ()=> box.remove());
    const histList = inner.querySelector('#histList');
    if (!list.length) histList.innerHTML = '<div class="muted">Belum ada riwayat.</div>';
    else {
      list.slice().reverse().forEach(it => {
        const itm = document.createElement('div'); itm.className='historyItem';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:800">${it.product} • ${it.note ? it.note.replace(/,/g,' • ') : ''}</div><div class="muted">${fmtWIB(it.createdAt)}</div>`;
        const right = document.createElement('div'); right.style.textAlign='right';
        right.innerHTML = `<div style="font-weight:800">${fmtRp(it.totalAmount||0)}</div><div class="muted">${it.status||'—'}</div>`;
        itm.appendChild(left); itm.appendChild(right);
        histList.appendChild(itm);
      });
    }
  }

  // docs button
  btnDocs.addEventListener('click', (e)=> { e.preventDefault(); toast('Docs: Pastikan env vars terpasang di Vercel (LICENSE_KEY, QRIS_STATIC_ID, PTLA, PTLC, DOMAIN).', { ttl:6000 }); });

  // ---------- init ----------
  loadPackages();
  loadHistory();

  // expose for debugging (optional)
  window._wanz = { createQris, pollStatusOnce, doCreatePanel };

})();
</script>
</body>
</html>