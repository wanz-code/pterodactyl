<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Order Panel Pterodactyl — Wanz Panel Store</title>
  <style>
    :root {
      --bg: #050616;
      --card: #0b1120;
      --muted: #9aa0b0;
      --accent: #7b61ff;
      --accent2: #00ffd1;
      --glass: rgba(255,255,255,0.04);
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: Inter, system-ui, Arial; background: linear-gradient(180deg,#010212,#071022); color: #eaf3ff; -webkit-font-smoothing:antialiased; }
    .app { max-width:1080px; margin:18px auto; padding:14px; padding-bottom:64px; }
    header { display:flex; align-items:center; gap:12px; justify-content:space-between; }
    .brand { display:flex; gap:12px; align-items:center; }
    .hamb { width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:800; color:#061018; cursor:pointer; }
    h1 { margin:0; font-size:18px; }
    .sub { color:var(--muted); font-size:13px; }
    .main { display:flex; gap:18px; margin-top:14px; }
    .grid { flex:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; transition: transform .18s ease, box-shadow .18s ease; }
    .card:hover { transform: translateY(-6px); box-shadow: 0 8px 30px rgba(0,0,0,0.6); }
    .card h3 { margin:0 0 6px 0; }
    .price { font-weight:800; color: var(--accent2); }
    .muted { color: var(--muted); font-size:13px; }
    .btn { background: linear-gradient(90deg,var(--accent),var(--accent2)); color:#061018; padding:8px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:800; }
    .sidebarBack { position:fixed; inset:0; display:none; background: rgba(0,0,0,0.5); z-index:80; }
    .sidebar { position:fixed; left:0; top:0; bottom:0; width:320px; max-width:86vw; background: linear-gradient(180deg,#071124,#091428); padding:16px; border-right:1px solid rgba(255,255,255,0.03); transform:translateX(-110%); transition: transform .25s cubic-bezier(.2,.9,.3,1); z-index:90; }
    .sidebar.open { transform: translateX(0); }
    .sidebar h3 { margin:0 0 8px 0; }
    .sidebar .closeX { position:absolute; right:10px; top:10px; background:transparent; border:0; color:var(--muted); font-weight:700; }
    .historyList { margin-top:12px; display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow:auto; padding-right:6px; }
    .histItem { background: var(--glass); padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }
    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.65); z-index:100; padding:12px; }
    .overlay.open { display:flex; }
    .modal { width:100%; max-width:920px; background: linear-gradient(180deg,#071022,#0b0f1c); padding:16px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); transform:translateY(12px); opacity:0; transition: transform .25s ease, opacity .25s ease; }
    .overlay.open .modal { transform:none; opacity:1; }
    .modalHeader { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .modalBody { margin-top:12px; }
    .field { margin-top:8px; }
    input,select,textarea { width:100%; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:#eaf3ff; }
    .qrBox { margin-top:12px; background:rgba(255,255,255,0.02); padding:12px; border-radius:8px; text-align:center; }
    img.qr { width:260px; height:260px; border-radius:8px; max-width:86vw; }
    .mutedSmall { color:var(--muted); font-size:13px; }
    .row { display:flex; gap:8px; align-items:center; }
    .col { display:flex; flex-direction:column; }
    .actions { display:flex; gap:8px; margin-top:12px; }
    .hint { font-size:13px; color:var(--muted); }
    .panelResult { margin-top:12px; }
    .chip { background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; display:inline-flex; gap:8px; align-items:center; }
    .tiny { font-size:12px; padding:6px 8px; border-radius:8px; }
    footer { text-align:center; font-size:13px; color:var(--muted); margin-top:32px; }
    @media (max-width:880px) { .grid { grid-template-columns: repeat(1,1fr); } .sidebar { width:86vw; } }
    .fade-in { animation: fadeIn .28s ease both; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }
    /* copy-code floating button (when viewing this file in browser) */
    .copyCodeBtn { position: fixed; left: 18px; bottom: 18px; z-index: 120; background: linear-gradient(90deg,var(--accent),var(--accent2)); color: #061018; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:800; }
    pre.codeDump { position: fixed; left: 18px; bottom: 64px; right:18px; max-height: 60vh; overflow:auto; background:#051022; color:#eaf3ff; padding:12px; border-radius:8px; display:none; z-index:119; border:1px solid rgba(255,255,255,0.03); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div id="hamb" class="hamb" title="Menu">☰</div>
        <div>
          <h1 id="pageTitle">Order panel pterodactyl</h1>
          <div class="sub">Mobile friendly • History tersimpan (WIB)</div>
        </div>
      </div>
      <div>
        <button id="btnHistoryTop" class="btn tiny">History</button>
      </div>
    </header>

    <main class="main">
      <section class="grid" id="grid"></section>
    </main>

    <footer>© 2025 Wanz Official</footer>
  </div>

  <div id="sidebarBack" class="sidebarBack"></div>

  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <button id="closeSidebar" class="closeX">✕</button>
    <h3>History Pesanan</h3>
    <div class="hint">Tersimpan di localStorage (status: pending/paid/cancel/expired). Semua waktu ditampilkan dalam WIB.</div>
    <div id="historyList" class="historyList"></div>
    <div style="margin-top:12px"><button id="clearHistory" class="btn tiny">Hapus semua history</button></div>
  </aside>

  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="modal fade-in">
      <div class="modalHeader">
        <div>
          <h3 id="mTitle">Beli panel</h3>
          <div id="mSub" class="mutedSmall">Isi username dan nomor untuk pembuatan panel otomatis</div>
        </div>
        <div class="row"><button id="closeModal" class="btn tiny">Tutup</button></div>
      </div>

      <div class="modalBody">
        <div class="field">
          <label>Username server</label>
          <input id="inputUser" placeholder="username (3-15)" inputmode="text" autocomplete="username" />
        </div>

        <div class="field">
          <label>Nomor WhatsApp (628...)</label>
          <input id="inputNomor" placeholder="628..." inputmode="numeric" autocomplete="tel" />
        </div>

        <div class="field">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div class="col">
              <div class="mutedSmall">Keterangan Paket</div>
              <div id="pkgDesc" class="hint" style="font-weight:800"></div>
            </div>
            <div class="col" style="align-items:flex-end;">
              <div class="price" id="pkgPrice"></div>
              <div class="mutedSmall">Expired 15 menit</div>
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="btnBuy" class="btn">Beli server</button>
          <button id="btnCancel" class="btn tiny" style="background:#ff7b7b">Batal</button>
        </div>

        <div id="qrWrap" class="qrBox" style="display:none;">
          <div id="qrInfo" class="mutedSmall"></div>
          <img id="qrImg" class="qr" src="" alt="QRIS" />
          <div style="margin-top:8px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
            <button id="btnDownload" class="btn tiny">Download QR</button>
            <button id="btnRefresh" class="btn tiny">Refresh status</button>
          </div>
          <div id="panelResult" class="panelResult mutedSmall"></div>
        </div>

      </div>
    </div>
  </div>

  <div id="toast" style="position:fixed; right:18px; top:18px; display:none; z-index:110;">
    <div class="chip"><div id="toastText">OK</div></div>
  </div>

  

  <script>
    /* ---------- Data & Helpers ---------- */

    const PACKAGES = {
      "1gb": { name: "1 GB", price: 10000, desc: "Basic 1 GB" },
      "2gb": { name: "2 GB", price: 20000, desc: "2 GB RAM" },
      "3gb": { name: "3 GB", price: 30000, desc: "3 GB RAM" },
      "unlimited": { name: "Unlimited", price: 150000, desc: "Unlimited" },
      "reseller": { name: "RESELLER", price: 250000, desc: "Reseller" }
    };

    const grid = document.getElementById('grid');
    const overlay = document.getElementById('overlay');
    const sidebar = document.getElementById('sidebar');
    const sidebarBack = document.getElementById('sidebarBack');
    const historyList = document.getElementById('historyList');
    const hamb = document.getElementById('hamb');
    const closeSidebar = document.getElementById('closeSidebar');
    const btnHistoryTop = document.getElementById('btnHistoryTop');
    const clearHistory = document.getElementById('clearHistory');

    const mTitle = document.getElementById('mTitle');
    const inputUser = document.getElementById('inputUser');
    const inputNomor = document.getElementById('inputNomor');
    const pkgDesc = document.getElementById('pkgDesc');
    const pkgPrice = document.getElementById('pkgPrice');
    const btnBuy = document.getElementById('btnBuy');
    const btnCancel = document.getElementById('btnCancel');
    const closeModal = document.getElementById('closeModal');

    const qrWrap = document.getElementById('qrWrap');
    const qrImg = document.getElementById('qrImg');
    const qrInfo = document.getElementById('qrInfo');
    const btnDownload = document.getElementById('btnDownload');
    const btnRefresh = document.getElementById('btnRefresh');
    const panelResult = document.getElementById('panelResult');

    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');

    let current = null;
    const STORAGE_KEY = 'wanz_store_history_v1';

    function nowISO(){ return new Date().toISOString(); }
    function fmtWIB(iso){ try { return new Date(iso).toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }); } catch(e){ return iso; } }

    function loadHistory(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch(e){ return []; }
    }

    function saveHistory(arr){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function pushHistory(item){
      const h = loadHistory();
      h.unshift(item);
      if (h.length > 200) h.pop();
      saveHistory(h);
      renderHistory();
    }

    function updateHistoryStatus(id, status, extra = {}){
      const h = loadHistory();
      const idx = h.findIndex(x => x.id === id);
      const timeWIB = fmtWIB(nowISO());
      if (idx === -1){
        const item = Object.assign({ id, status, timeWIB }, extra);
        pushHistory(item);
        return;
      }
      h[idx] = Object.assign({}, h[idx], { status, timeWIB }, extra);
      saveHistory(h);
      renderHistory();
    }

    function renderHistory(){
      const h = loadHistory();
      historyList.innerHTML = '';
      if (!h.length){
        historyList.innerHTML = '<div class=\"hint\">Belum ada history</div>';
        return;
      }
      h.forEach(it => {
        const el = document.createElement('div');
        el.className = 'histItem';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between">
            <div>
              <strong>${it.pkgName}</strong>
              <div class="mutedSmall">${it.username} • ${it.nomor}</div>
            </div>
            <div style="text-align:right">
              <div class="mutedSmall">${it.status}</div>
              <div class="mutedSmall">${it.timeWIB || '-'}</div>
            </div>
          </div>
        `;
        el.addEventListener('click', () => showHistoryDetail(it));
        historyList.appendChild(el);
      });
    }

    function showHistoryDetail(it){
      let html = `<div style="font-weight:800;margin-bottom:8px">${it.pkgName} — ${it.status}</div>`;
      html += `<div class="mutedSmall">User: ${it.username}</div>`;
      html += `<div class="mutedSmall">Nomor: ${it.nomor}</div>`;
      html += `<div class="mutedSmall">Waktu: ${it.timeWIB || '-'}</div>`;
      if (it.expiredAt) html += `<div class="mutedSmall">Expired At: ${fmtWIB(it.expiredAt)}</div>`;
      if (it.panel) html += `<div style="margin-top:8px"><pre style="max-height:160px;overflow:auto">${escapeHtml(JSON.stringify(it.panel, null, 2))}</pre></div>`;
      showToast(html, 8000);
    }

    function escapeHtml(s){
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    /* ---------- Render products ---------- */
    function renderProducts(){
      grid.innerHTML = '';
      Object.keys(PACKAGES).forEach(key => {
        const p = PACKAGES[key];
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${p.name}</h3>
          <div class="muted">${p.desc}</div>
          <div style="display:flex;justify-content:space-between;margin-top:10px">
            <div><div class="price">Rp${Number(p.price).toLocaleString('id-ID')}</div></div>
            <div><button class="btn" data-key="${key}">Detail</button></div>
          </div>
        `;
        grid.appendChild(card);
      });
      grid.querySelectorAll('button.btn').forEach(b => b.addEventListener('click', e => openModal(e.currentTarget.dataset.key)));
    }

    /* ---------- Modal open/close ---------- */
    function openModal(key){
      const p = PACKAGES[key];
      current = { key, pkg: p, trxId: null, poll: null };
      mTitle.textContent = `Beli: ${p.name}`;
      pkgDesc.textContent = p.desc;
      pkgPrice.textContent = `Rp${Number(p.price).toLocaleString('id-ID')}`;
      inputUser.value = '';
      inputNomor.value = '';
      panelResult.textContent = '';
      qrWrap.style.display = 'none';
      overlay.classList.add('open');
    }

    function closeModalFn(){
      overlay.classList.remove('open');
      stopPolling();
    }

    closeModal.addEventListener('click', closeModalFn);
    btnCancel.addEventListener('click', () => {
      if (current && current.trxId) updateHistoryStatus(current.trxId, 'cancel');
      closeModalFn();
      showToast('Dibatalkan');
    });
    overlay.addEventListener('click', ev => { if (ev.target === overlay) closeModalFn(); });

    /* ---------- Sidebar controls ---------- */
    hamb.addEventListener('click', () => { sidebar.classList.add('open'); sidebarBack.style.display = 'block'; });
    closeSidebar.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarBack.style.display = 'none'; });
    btnHistoryTop.addEventListener('click', () => { sidebar.classList.add('open'); sidebarBack.style.display = 'block'; });
    sidebarBack.addEventListener('click', () => { sidebar.classList.remove('open'); sidebarBack.style.display = 'none'; });
    clearHistory.addEventListener('click', () => { if (confirm('Hapus semua history?')) { localStorage.removeItem(STORAGE_KEY); renderHistory(); showToast('History dibersihkan'); } });

    /* ---------- Toast ---------- */
    function showToast(msg, t = 3000){
      toastText.innerHTML = msg;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', t);
    }

    /* ---------- Network helpers ---------- */
    async function postJson(url, body){
      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await res.json();
        return j;
      } catch (e) {
        return { ok: false, error: 'network' };
      }
    }

    /* ---------- Buy flow (create QR & polling) ---------- */
    btnBuy.addEventListener('click', async () => {
      if (!current) return showToast('Paket tidak dipilih');
      const username = inputUser.value.trim();
      const nomor = inputNomor.value.trim();
      if (!/^[a-zA-Z0-9_]{3,15}$/.test(username)) return showToast('Username invalid (3-15 chars)');
      if (!/^[0-9]{8,15}$/.test(nomor)) return showToast('Nomor invalid (628...)');

      btnBuy.disabled = true;
      btnBuy.textContent = 'Generating QRIS...';
      showToast('Membuat QRIS...');

      try {
        const body = { productKey: current.key, username, nomor };
        const r = await postJson('/api/database?action=create-qris', body);
        if (!r.ok) {
          showToast('Gagal membuat QRIS: ' + (r.error || 'unknown'));
          btnBuy.disabled = false; btnBuy.textContent = 'Beli server';
          return;
        }

        const q = r.qris || {};
        current.trxId = q.transactionId || (q.raw && q.raw.data && q.raw.data.transactionId) || ('local-'+Date.now());

        const total = q.totalAmount || q.originalAmount || current.pkg.price;
        const expiredAt = q.expiredAt || null;

        // push initial history (pending)
        pushHistory({
          id: current.trxId,
          pkgName: current.pkg.name,
          username,
          nomor,
          status: 'pending',
          timeWIB: fmtWIB(nowISO()),
          expiredAt
        });

        // display QR area
        if (q.qr_image) { qrImg.src = q.qr_image; qrImg.style.display = 'block'; }
        else { qrImg.style.display = 'none'; }
        qrInfo.innerHTML = `Trx: <strong>${current.trxId}</strong> • Nominal: <strong>Rp${Number(total).toLocaleString('id-ID')}</strong> • Exp: ${ expiredAt ? fmtWIB(expiredAt) : '15 menit' }`;
        qrWrap.style.display = 'block';
        panelResult.textContent = 'Menunggu pembayaran...';

        // download
        if (q.qr_image) {
          btnDownload.onclick = () => downloadDataUrl(q.qr_image, `qris-${current.trxId || Date.now()}.png`);
        } else {
          btnDownload.onclick = () => showToast('Server tidak mengembalikan gambar QR.');
        }

        // refresh
        btnRefresh.onclick = checkStatusOnce;

        // start polling
        startPolling();

      } catch (e) {
        console.error(e);
        showToast('Error creating qris');
      } finally {
        btnBuy.disabled = false;
        btnBuy.textContent = 'Beli server';
      }
    });

    /* ---------- Polling ---------- */
    function startPolling(){
      stopPolling();
      if (!current || !current.trxId) return;
      current.poll = setInterval(checkStatusOnce, 5000);
    }

    function stopPolling(){
      if (current && current.poll) { clearInterval(current.poll); current.poll = null; }
    }

    async function checkStatusOnce(){
      if (!current || !current.trxId) return;
      try {
        const body = { transactionId: current.trxId, productKey: current.key, username: inputUser.value.trim(), nomor: inputNomor.value.trim() };
        const j = await postJson('/api/database?action=check-status', body);
        if (!j.ok) { console.warn('check failed', j); return; }
        const status = j.status || (j.raw && j.raw.data && j.raw.data.status) || null;

        // update history
        updateHistoryStatus(current.trxId, status || 'pending', { expiredAt: (j.raw && j.raw.data && j.raw.data.expiredAt) || undefined });

        if (status === 'paid') {
          stopPolling();
          showToast('Pembayaran diterima. Membuat panel...');
          if (j.panel) {
            panelResult.innerHTML = renderPanelInfo(j.panel);
            updateHistoryStatus(current.trxId, 'paid', { panel: j.panel });
          } else {
            panelResult.textContent = 'Pembayaran terdeteksi. Menunggu pembuatan panel...';
            // try another immediate check
            await new Promise(r => setTimeout(r, 1200));
            const j2 = await postJson('/api/database?action=check-status', body);
            if (j2.ok && j2.panel) {
              panelResult.innerHTML = renderPanelInfo(j2.panel);
              updateHistoryStatus(current.trxId, 'paid', { panel: j2.panel });
            }
          }
        } else if (status === 'expired') {
          stopPolling();
          panelResult.textContent = 'Order expired';
          showToast('Order expired');
          updateHistoryStatus(current.trxId, 'expired', {});
        } else {
          // pending - do nothing
        }
      } catch (e) {
        console.warn('poll error', e);
      }
    }

    /* ---------- render panel info ---------- */
    function renderPanelInfo(panel){
      try {
        const asObj = (typeof panel === 'string') ? JSON.parse(panel) : panel;
        const domain = asObj.domain || asObj.serverHostname || asObj.hostname || window.location.origin;
        const user = asObj.username || asObj.user || inputUser.value.trim();
        const pass = asObj.password || asObj.pw || asObj.access_password || '';
        const html = [];
        html.push(`<div style="font-weight:800;color:var(--accent)">Panel dibuat</div>`);
        html.push(`<div style="margin-top:8px">`);
        html.push(`<div class="row" style="justify-content:space-between">`);
        html.push(`<div><div class="mutedSmall">Username</div><div class="chip">${escapeHtml(user)} <button class="tiny" onclick="copyText('${escapeSingle(user)}')">Copy</button></div></div>`);
        html.push(`<div><div class="mutedSmall">Password</div><div class="chip">${escapeHtml(pass)} <button class="tiny" onclick="copyText('${escapeSingle(pass)}')">Copy</button></div></div>`);
        html.push(`</div>`);
        html.push(`</div>`);
        html.push(`<div style="margin-top:8px"><div class="mutedSmall">Domain</div><div class="chip">${escapeHtml(domain)} <button class="tiny" onclick="window.open('${escapeSingle(domain)}','_blank')">Login</button></div></div>`);
        return html.join('');
      } catch (e) {
        return `<div>Panel dibuat: <pre>${escapeHtml(String(panel)).slice(0,200)}</pre></div>`;
      }
    }

    function escapeSingle(s){ if (!s) return ''; return String(s).replace(/'/g, "\\'").replace(/"/g, '\\"'); }

    function copyText(s){
      if (!s) return showToast('Tidak ada data untuk disalin');
      navigator.clipboard.writeText(s).then(() => showToast('Disalin ke clipboard')).catch(()=>showToast('Gagal salin'));
    }

    function downloadDataUrl(dataUrl, filename){
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    /* ---------- init ---------- */
    renderProducts();
    renderHistory();

    /* ---------- optional: copy-this-file helper (when viewing this HTML in browser) ---------- */
    (function attachCopyUI(){
      const btn = document.getElementById('copyCodeBtn');
      const dump = document.getElementById('codeDump');
      if (!btn || !dump) return;
      // fill dump with the outerHTML of documentElement (nicely)
      
      btn.addEventListener('click', async () => {
        try {
          // We will copy the full HTML source by serializing document.doctype + html
          const doctype = new XMLSerializer().serializeToString(document.doctype);
          const html = document.documentElement.outerHTML;
          const full = doctype + "\\n" + html;
          await navigator.clipboard.writeText(full);
          btn.textContent = 'Tersalin ✓';
        } catch (e) {
          // fallback: show pre with source for manual copy
          dump.style.display = 'block';
          dump.textContent = '<!doctype html>\\n' + document.documentElement.outerHTML;
          btn.textContent = 'Tampilkan Kode';
        }
      });
    })();

  </script>
</body>
</html>